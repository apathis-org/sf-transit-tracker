<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Transit API Test Dashboard - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .agency-card {
            border-left: 4px solid;
        }

        .agency-sf { border-left-color: #e31837; }
        .agency-gg { border-left-color: #006a4e; }
        .agency-ac { border-left-color: #4CAF50; }
        .agency-rg { border-left-color: #ff6600; }

        .test-card h3 {
            margin-bottom: 15px;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .agency-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .agency-icon {
            font-size: 2rem;
        }

        .agency-info {
            flex: 1;
        }

        .agency-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4facfe;
        }

        .agency-description {
            font-size: 0.9rem;
            color: #ccc;
            margin-top: 5px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            animation: pulse 1s infinite;
        }

        .status-indicator.testing { background: #ff9800; }
        .status-indicator.success { background: #4caf50; animation: none; }
        .status-indicator.error { background: #f44336; animation: none; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .test-button {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
            width: 100%;
        }

        .test-button:hover {
            transform: translateY(-2px);
        }

        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .result-container {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .result-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .metric-label {
            color: #ccc;
        }

        .metric-value {
            color: #4facfe;
            font-weight: bold;
        }

        .transport-breakdown {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }

        .transport-type {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .transport-type:last-child {
            border-bottom: none;
        }

        .transport-icon {
            margin-right: 8px;
        }

        .error {
            color: #ff5722;
        }

        .success {
            color: #4caf50;
        }

        .warning {
            color: #ff9800;
        }

        .summary-card {
            grid-column: 1 / -1;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
        }

        .summary-label {
            color: #ccc;
            margin-top: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .coverage-map {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-family: monospace;
        }

        .bart-input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
            margin-right: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            width: 250px;
        }

        .bart-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .small-button {
            width: auto;
            padding: 8px 16px;
            margin-left: 5px;
        }

        .info-box {
            background: rgba(79, 172, 254, 0.15);
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .info-box h3 {
            color: #4facfe;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-box ul {
            margin: 0;
            padding-left: 20px;
            color: #e0e0e0;
            line-height: 1.5;
        }

        .info-box li {
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ SF Transit API Test Dashboard - Enhanced</h1>
            <p>Comprehensive route-level testing by Bay Area transit agency</p>
            <div class="controls">
                <button class="control-button" onclick="testAllAgencies()">üöÄ Test All Agencies</button>
                <button class="control-button" onclick="clearResults()">üßπ Clear Results</button>
                <button class="control-button" onclick="toggleLiveMode()">üì° Toggle Live Mode</button>
                <button class="control-button" onclick="exportResults()">üíæ Export Results</button>
            </div>
        </div>

        <div class="info-box">
            <h3>üìã Testing vs Production Note</h3>
            <ul>
                <li>This dashboard tests all 4 individual API endpoints (SF, GG, AC, RG) for comprehensive validation</li>
                <li>Production app uses optimized 2-call approach (SF + RG only) for 50% fewer API calls</li>
                <li>Same data coverage: GG and AC vehicles are included in the RG (Regional) feed</li>
                <li>All endpoints tested here remain valid - this ensures our optimization assumptions are correct</li>
            </ul>
        </div>

        <div class="test-grid">
            <!-- SFMTA Test Card -->
            <div class="test-card agency-card agency-sf">
                <div class="agency-title">
                    <div class="agency-icon">üöå</div>
                    <div class="agency-info">
                        <div class="agency-name">SFMTA (SF)</div>
                        <div class="agency-description">San Francisco Municipal Transportation</div>
                    </div>
                    <span class="status-indicator" id="sf-status"></span>
                </div>
                <div class="coverage-map">Coverage: San Francisco city only</div>
                <button class="test-button" onclick="testAgency('SF')" id="sf-btn">Test SFMTA</button>
                <div class="result-container" id="sf-result">
                    <p>Click to test SFMTA (Muni buses, light rail, cable cars)...</p>
                </div>
            </div>

            <!-- Golden Gate Test Card -->
            <div class="test-card agency-card agency-gg">
                <div class="agency-title">
                    <div class="agency-icon">‚õ¥Ô∏è</div>
                    <div class="agency-info">
                        <div class="agency-name">Golden Gate (GG)</div>
                        <div class="agency-description">North Bay Transit & Ferry</div>
                    </div>
                    <span class="status-indicator" id="gg-status"></span>
                </div>
                <div class="coverage-map">Coverage: SF ‚Üî Marin, Sonoma counties</div>
                <button class="test-button" onclick="testAgency('GG')" id="gg-btn">Test Golden Gate</button>
                <div class="result-container" id="gg-result">
                    <p>Click to test Golden Gate (ferries, north bay buses)...</p>
                </div>
            </div>

            <!-- AC Transit Test Card -->
            <div class="test-card agency-card agency-ac">
                <div class="agency-title">
                    <div class="agency-icon">üåâ</div>
                    <div class="agency-info">
                        <div class="agency-name">AC Transit (AC)</div>
                        <div class="agency-description">Alameda-Contra Costa Transit</div>
                    </div>
                    <span class="status-indicator" id="ac-status"></span>
                </div>
                <div class="coverage-map">Coverage: East Bay ‚Üî SF via Bay Bridge</div>
                <button class="test-button" onclick="testAgency('AC')" id="ac-btn">Test AC Transit</button>
                <div class="result-container" id="ac-result">
                    <p>Click to test AC Transit (east bay buses, transbay routes)...</p>
                </div>
            </div>

            <!-- Regional Test Card -->
            <div class="test-card agency-card agency-rg">
                <div class="agency-title">
                    <div class="agency-icon">üåâ</div>
                    <div class="agency-info">
                        <div class="agency-name">Regional (RG)</div>
                        <div class="agency-description">All Bay Area Agencies Combined</div>
                    </div>
                    <span class="status-indicator" id="rg-status"></span>
                </div>
                <div class="coverage-map">Coverage: Entire 9-county Bay Area</div>
                <button class="test-button" onclick="testAgency('RG')" id="rg-btn">Test Regional Feed</button>
                <div class="result-container" id="rg-result">
                    <p>Click to test Regional feed (BART, VTA, SamTrans, Caltrain, all agencies)...</p>
                </div>
            </div>

            <!-- Enhanced 511 Analysis -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="enhanced-status"></span>
                    üîç Enhanced 511 Route Analysis
                </h3>
                <button class="test-button" onclick="testEnhanced511()" id="enhanced-btn">Test Enhanced Analysis</button>
                <div class="result-container" id="enhanced-result">
                    <p>Click to test enhanced route-level analysis by transport type (Top 5 routes per agency)...</p>
                </div>
            </div>

            <!-- BART Lines Overview -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="bart-overview-status"></span>
                    üöá BART Lines Overview
                </h3>
                <button class="test-button" onclick="testBartOverview()" id="bart-overview-btn">Test BART Lines</button>
                <div class="result-container" id="bart-overview-result">
                    <p>Click to test BART lines overview with summary of all active lines...</p>
                </div>
            </div>

            <!-- BART Line Analysis -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="bart-line-status"></span>
                    üöá BART Line Details
                </h3>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="bart-line-input" class="bart-input" placeholder="Enter BART line (e.g., ANTC, DALY, FRMT)">
                    <button class="test-button small-button" onclick="testBartLineDetails()" id="bart-line-btn">Analyze Line</button>
                </div>
                <div class="result-container" id="bart-line-result">
                    <p>Enter a BART line code to analyze detailed station and departure info...</p>
                    <div style="font-size: 11px; color: #aaa; margin-top: 10px;">
                        Common lines: ANTC, DALY, DUBL, FRMT, MLBR, RICH, WARM
                    </div>
                </div>
            </div>
            <!-- GTFS Routes Data Test -->
            <div class="test-card">
              <h3>
                <span class="status-indicator" id="gtfs-status"></span>
                üó∫Ô∏è GTFS Routes Data
              </h3>
              <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="test-button"
                        onclick="testRoutes()"
                        id="routes-btn"
                        style="flex: 1;">
                  Test Routes
                </button>
                <button class="test-button"
                        onclick="refreshGTFS()"
                        id="refresh-btn"
                        style="flex: 1; background: linear-gradient(45deg, #ff6b35, #f7931e);">
                  Refresh GTFS
                </button>
              </div>
              <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="test-button"
                        onclick="testGTFSConnectivity()"
                        id="connectivity-btn"
                        style="background: linear-gradient(45deg, #9c27b0, #673ab7);">
                  Test Connectivity
                </button>
              </div>
              <div class="result-container" id="gtfs-result">
                <p>Click to test route data loading or refresh GTFS from SFMTA‚Ä¶</p>
                <div style="font-size: 11px; color: #aaa; margin-top: 10px;">
                  ‚Ä¢ Test Routes: Load existing route data<br>
                  ‚Ä¢ Refresh GTFS: Download fresh SFMTA data<br>
                  ‚Ä¢ Test Connectivity: Debug connection issues
                </div>
              </div>
            </div>
            <!-- Server Health Test -->
            <div class="test-card">
                <h3>
                    <span class="status-indicator" id="health-status"></span>
                    üè• Server Health Check
                </h3>
                <button class="test-button" onclick="testServerHealth()" id="health-btn">Test Server Health</button>
                <div class="result-container" id="health-result">
                    <p>Click to test server health and configuration...</p>
                </div>
            </div>

            <!-- NextMuni API removed - no longer needed as 511.org provides comprehensive SFMTA data -->

            <!-- Summary Card -->
            <div class="summary-card">
                <h3>üìä Bay Area Transit Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value" id="total-agencies">0</div>
                        <div class="summary-label">Agencies Tested</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-vehicles">0</div>
                        <div class="summary-label">Total Vehicles</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="success-rate">0%</div>
                        <div class="summary-label">Success Rate</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="avg-response">0ms</div>
                        <div class="summary-label">Avg Response</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="last-update">--:--</div>
                        <div class="summary-label">Last Update</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="coverage-area">9</div>
                        <div class="summary-label">Counties Covered</div>
                    </div>
                </div>

                <div class="coverage-map">
                    Bay Area Coverage Map:<br>
                    Sonoma--Napa<br>
                    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                    Marin--üåâ--SF<br>
                    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                    Contra Costa--+<br>
                    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                    Alameda--San Mateo<br>
                    &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br>
                    Santa Clara--+
                </div>
            </div>
        </div>
    </div>

    <script>
        let testResults = {};
        let liveMode = false;
        let liveInterval = null;

        const agencyInfo = {
            'SF': {
                name: 'SFMTA',
                description: 'San Francisco Municipal Transportation',
                transportTypes: {
                    'muni-bus': { icon: 'üöå', name: 'Muni Buses', routes: ['1', '5', '8', '14', '21', '22', '24', '27', '28', '30', '31', '33', '38', '43', '44', '45', '49'] },
                    'light-rail': { icon: 'üöä', name: 'Light Rail', routes: ['J', 'K', 'L', 'M', 'N', 'T'] },
                    'cable-car': { icon: 'üö°', name: 'Cable Cars', routes: ['PH', 'PM', 'CA'] }
                }
            },
            'GG': {
                name: 'Golden Gate',
                description: 'North Bay Transit & Ferry',
                transportTypes: {
                    'ferry': { icon: '‚õ¥Ô∏è', name: 'Ferries', routes: ['Sausalito', 'Tiburon', 'Larkspur'] },
                    'bus': { icon: 'üöå', name: 'GG Buses', routes: ['101', '130', '140', '150'] }
                }
            },
            'AC': {
                name: 'AC Transit',
                description: 'Alameda-Contra Costa Transit',
                transportTypes: {
                    'bus': { icon: 'üöå', name: 'AC Buses', routes: ['1', '6', '18', '51A', '72', '88'] },
                    'transbay': { icon: 'üåâ', name: 'Transbay Routes', routes: ['F', 'FS', 'G', 'NL', 'O', 'P', 'T', 'TE', 'U', 'V', 'W', 'Z'] }
                }
            },
            'RG': {
                name: 'Regional',
                description: 'All Bay Area Agencies',
                transportTypes: {
                    'bart': { icon: 'üöá', name: 'BART', routes: ['Red', 'Blue', 'Green', 'Yellow', 'Orange'] },
                    'caltrain': { icon: 'üöÇ', name: 'Caltrain', routes: ['Local', 'Limited', 'Express'] },
                    'vta': { icon: 'üöå', name: 'VTA', routes: ['Light Rail', 'Buses'] },
                    'samtrans': { icon: 'üöå', name: 'SamTrans', routes: ['Local', 'Express'] },
                    'all-muni': { icon: 'üöå', name: 'All Transit', routes: ['Combined Feed'] }
                }
            }
        };

        async function testAgency(agencyCode) {
            const statusEl = document.getElementById(`${agencyCode.toLowerCase()}-status`);
            const resultEl = document.getElementById(`${agencyCode.toLowerCase()}-result`);
            const btnEl = document.getElementById(`${agencyCode.toLowerCase()}-btn`);

            setTestStatus(agencyCode.toLowerCase(), 'testing');
            btnEl.disabled = true;

            try {
                // Call filtered API for specific agency
                const response = await fetch(`/test/511-api?agency=${agencyCode}`);
                const data = await response.json();

                if (response.ok) {
                    setTestStatus(agencyCode.toLowerCase(), 'success');
                    testResults[agencyCode] = { status: 'success', data };

                    let html = `
                        <div class="success">‚úÖ ${agencyInfo[agencyCode].name}: Connected</div>
                        <div class="metric">
                            <span class="metric-label">Agency Vehicles:</span>
                            <span class="metric-value">${data.vehicleCount || 0}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Response Time:</span>
                            <span class="metric-value">${Math.round(data.responseTime || 0)}ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">API Status:</span>
                            <span class="metric-value">${data.apiKeyValid ? '‚úÖ Valid' : '‚ùå Invalid'}</span>
                        </div>
                    `;

                    if (data.sampleVehicle) {
                        html += `
                            <div class="transport-breakdown">
                                <strong>Sample Vehicle:</strong>
                                <div class="transport-type">
                                    <span>üöå ${data.sampleVehicle.type}</span>
                                    <span>Route: ${data.sampleVehicle.route || 'Unknown'}</span>
                                </div>
                            </div>
                        `;
                    }

                    // Add enhanced analysis button if vehicles found
                    if (data.vehicleCount > 0) {
                        html += `
                            <button class="test-button" onclick="testAgencyEnhanced('${agencyCode}')"
                                    id="${agencyCode.toLowerCase()}-enhanced-btn" style="margin-top: 10px;">
                                üîç Enhanced Route Analysis
                            </button>
                            <div id="${agencyCode.toLowerCase()}-enhanced-result" style="display: none;"></div>
                        `;
                    }

                    html += `
                        <div style="margin-top: 10px; font-size: 11px; color: #888;">
                            Last updated: ${new Date().toLocaleTimeString()}
                        </div>
                    `;

                    resultEl.innerHTML = html;
                } else {
                    throw new Error(`Server test failed: ${response.status}`);
                }
            } catch (error) {
                setTestStatus(agencyCode.toLowerCase(), 'error');
                testResults[agencyCode] = { status: 'error', error: error.message };
                resultEl.innerHTML = `
                    <div class="error">‚ùå ${agencyInfo[agencyCode].name} Error</div>
                    <div class="error">Error: ${error.message}</div>
                    <div class="warning">üí° Check your SF_511_API_KEY in .env file</div>
                `;
            }

            btnEl.disabled = false;
            updateSummary();
        }

        async function testAgencyEnhanced(agencyCode) {
            const enhancedResultEl = document.getElementById(`${agencyCode.toLowerCase()}-enhanced-result`);
            const enhancedBtnEl = document.getElementById(`${agencyCode.toLowerCase()}-enhanced-btn`);

            enhancedBtnEl.disabled = true;
            enhancedResultEl.style.display = 'block';
            enhancedResultEl.innerHTML = `<div style="color: #ff9800;">üîÑ Loading enhanced analysis for ${agencyCode}...</div>`;

            try {
                const response = await fetch('/test/enhanced-511-api');
                const data = await response.json();

                if (response.ok && data.agencies && data.agencies[agencyCode]) {
                    const agencyData = data.agencies[agencyCode];

                    if (agencyData.status === 'success') {
                        let html = `
                            <div class="transport-breakdown" style="margin-top: 10px; border: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong>üîç ${agencyData.name} Route Analysis</strong>
                                    <button onclick="document.getElementById('${agencyCode.toLowerCase()}-enhanced-result').style.display='none'"
                                            style="background: rgba(255,0,0,0.2); border: none; color: white; padding: 2px 6px; border-radius: 3px; cursor: pointer;">‚úï</button>
                                </div>
                                <div style="margin: 8px 0; font-size: 11px;">
                                    <div>üìä ${agencyData.vehicleCount} vehicles, ${agencyData.routeCount} routes</div>
                                    <div>‚è±Ô∏è ${Math.round(agencyData.responseTime)}ms response</div>
                                </div>
                        `;

                        // Transport types breakdown
                        for (const [typeCode, typeData] of Object.entries(agencyData.transportTypes || {})) {
                            html += `
                                <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                    <strong style="color: #4facfe;">${typeData.name}</strong>
                                    <div style="margin-left: 15px; font-size: 10px;">
                            `;

                            // Top routes for this transport type
                            typeData.routes.forEach(route => {
                                const destinations = route.destinations.length > 0 ? ` ‚Üí ${route.destinations.join(', ')}` : '';
                                html += `
                                    <div style="margin: 3px 0; cursor: pointer; padding: 2px; border-radius: 2px;"
                                         onclick="testRouteDetailsInAgency('${agencyCode}', '${route.route}', '${agencyCode.toLowerCase()}-enhanced-result')"
                                         onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                         onmouseout="this.style.background='transparent'">
                                        üîó <strong>${route.route}</strong> (${route.count} vehicles)${destinations}
                                    </div>
                                `;
                            });

                            html += `
                                    </div>
                                </div>
                            `;
                        }

                        html += `
                                <div style="margin-top: 10px; font-size: 11px; color: #888;">
                                    Click any route above for vehicle details ‚Ä¢ ${new Date().toLocaleTimeString()}
                                </div>
                            </div>
                        `;

                        enhancedResultEl.innerHTML = html;
                    } else {
                        enhancedResultEl.innerHTML = `<div class="error">‚ùå Enhanced analysis failed: ${agencyData.error}</div>`;
                    }
                } else {
                    enhancedResultEl.innerHTML = `<div class="error">‚ùå No enhanced data available for ${agencyCode}</div>`;
                }
            } catch (error) {
                enhancedResultEl.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }

            enhancedBtnEl.disabled = false;
        }

        async function testRouteDetailsInAgency(agency, route, containerId) {
            // Create route details within the agency's enhanced section
            const containerEl = document.getElementById(containerId);
            let detailsEl = document.getElementById(`route-details-${agency}-${route}-agency`);

            if (!detailsEl) {
                detailsEl = document.createElement('div');
                detailsEl.id = `route-details-${agency}-${route}-agency`;
                detailsEl.className = 'transport-breakdown';
                detailsEl.style.marginTop = '10px';
                detailsEl.style.border = '1px solid rgba(255,255,255,0.3)';
                containerEl.appendChild(detailsEl);
            }

            detailsEl.innerHTML = `<div style="color: #ff9800;">üîÑ Loading route details for ${agency}-${route}...</div>`;

            try {
                const response = await fetch(`/test/route-details/${agency}/${route}`);
                const data = await response.json();

                if (response.ok) {
                    let html = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #4facfe;">üìã Route ${data.route} Details</strong>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,0,0,0.2); border: none; color: white; padding: 2px 6px; border-radius: 3px; cursor: pointer;">‚úï</button>
                        </div>
                        <div style="margin: 8px 0; font-size: 11px;">
                            <div>üöå Type: ${data.vehicleType} | Vehicles: ${data.vehicleCount} | ${Math.round(data.responseTime)}ms</div>
                        </div>
                    `;

                    // Directions
                    if (Object.keys(data.directions).length > 0) {
                        html += `<div style="margin: 8px 0; font-size: 11px;"><strong>Directions:</strong>`;
                        for (const [direction, count] of Object.entries(data.directions)) {
                            html += ` <span style="background: rgba(79,172,254,0.2); padding: 1px 4px; border-radius: 2px; margin: 1px; font-size: 9px;">${direction} (${count})</span>`;
                        }
                        html += `</div>`;
                    }

                    // Sample vehicles
                    if (data.vehicles.length > 0) {
                        html += `
                            <div style="margin: 8px 0;">
                                <strong style="font-size: 11px;">Sample Vehicles:</strong>
                                <div style="max-height: 80px; overflow-y: auto; margin-top: 4px;">
                        `;

                        data.vehicles.slice(0, 3).forEach(vehicle => {
                            html += `
                                <div style="font-size: 9px; margin: 1px 0; padding: 2px; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                    üöå ${vehicle.id}: (${vehicle.lat.toFixed(4)}, ${vehicle.lng.toFixed(4)}) ${Math.round(vehicle.speed)}mph ${Math.round(vehicle.heading)}¬∞
                                </div>
                            `;
                        });

                        html += `</div></div>`;
                    }

                    detailsEl.innerHTML = html;
                } else {
                    detailsEl.innerHTML = `<div class="error">‚ùå Route details failed: ${data.error}</div>`;
                }
            } catch (error) {
                detailsEl.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testEnhanced511() {
            const statusEl = document.getElementById('enhanced-status');
            const resultEl = document.getElementById('enhanced-result');
            const btnEl = document.getElementById('enhanced-btn');

            setTestStatus('enhanced', 'testing');
            btnEl.disabled = true;

            try {
                const response = await fetch('/test/enhanced-511-api');
                const data = await response.json();

                if (response.ok) {
                    setTestStatus('enhanced', 'success');

                    let html = `
                        <div class="success">‚úÖ Enhanced 511 Analysis: Complete</div>
                        <div class="metric">
                            <span class="metric-label">Total Vehicles:</span>
                            <span class="metric-value">${data.totalVehicles}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Routes:</span>
                            <span class="metric-value">${data.totalRoutes}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Agencies Analyzed:</span>
                            <span class="metric-value">${Object.keys(data.agencies).length}</span>
                        </div>
                    `;

                    // Agency breakdown
                    for (const [agencyCode, agencyData] of Object.entries(data.agencies)) {
                        if (agencyData.status === 'success') {
                            html += `
                                <div class="transport-breakdown">
                                    <strong>${agencyData.name} (${agencyCode}):</strong>
                                    <div style="margin-left: 10px; font-size: 11px;">
                                        <div>üìä ${agencyData.vehicleCount} vehicles, ${agencyData.routeCount} routes</div>
                                        <div>‚è±Ô∏è ${Math.round(agencyData.responseTime)}ms response</div>
                                    </div>
                            `;

                            // Transport types breakdown
                            for (const [typeCode, typeData] of Object.entries(agencyData.transportTypes || {})) {
                                html += `
                                    <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                                        <strong style="color: #4facfe;">${typeData.name}</strong>
                                        <div style="margin-left: 15px; font-size: 10px;">
                                `;

                                // Top routes for this transport type
                                typeData.routes.forEach(route => {
                                    const destinations = route.destinations.length > 0 ? ` ‚Üí ${route.destinations.join(', ')}` : '';
                                    html += `
                                        <div style="margin: 3px 0; cursor: pointer; padding: 2px; border-radius: 2px;"
                                             onclick="testRouteDetails('${agencyCode}', '${route.route}')"
                                             onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                             onmouseout="this.style.background='transparent'">
                                            üîó <strong>${route.route}</strong> (${route.count} vehicles)${destinations}
                                        </div>
                                    `;
                                });

                                html += `
                                        </div>
                                    </div>
                                `;
                            }

                            html += `</div>`;
                        } else {
                            html += `
                                <div class="transport-breakdown">
                                    <strong style="color: #f44336;">${agencyData.name} (${agencyCode}): ‚ùå ${agencyData.error}</strong>
                                </div>
                            `;
                        }
                    }

                    html += `<div style="margin-top: 10px; font-size: 11px; color: #888;">
                        Click any route above for detailed analysis ‚Ä¢ Last updated: ${new Date().toLocaleTimeString()}
                    </div>`;

                    resultEl.innerHTML = html;
                } else {
                    throw new Error(`Enhanced analysis failed: ${response.status}`);
                }
            } catch (error) {
                setTestStatus('enhanced', 'error');
                resultEl.innerHTML = `
                    <div class="error">‚ùå Enhanced Analysis Error</div>
                    <div class="error">Error: ${error.message}</div>
                    <div class="warning">üí° Check your SF_511_API_KEY in .env file</div>
                `;
            }

            btnEl.disabled = false;
        }

        async function testRouteDetails(agency, route) {
            // Create or update route details section
            let detailsEl = document.getElementById(`route-details-${agency}-${route}`);
            if (!detailsEl) {
                // Add details section after the enhanced result
                const enhancedResult = document.getElementById('enhanced-result');
                detailsEl = document.createElement('div');
                detailsEl.id = `route-details-${agency}-${route}`;
                detailsEl.className = 'transport-breakdown';
                detailsEl.style.marginTop = '10px';
                detailsEl.style.border = '1px solid rgba(255,255,255,0.2)';
                enhancedResult.appendChild(detailsEl);
            }

            detailsEl.innerHTML = `<div style="color: #ff9800;">üîÑ Loading route details for ${agency}-${route}...</div>`;

            try {
                const response = await fetch(`/test/route-details/${agency}/${route}`);
                const data = await response.json();

                if (response.ok) {
                    let html = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #4facfe;">üìã Route ${data.route} Details (${data.agency})</strong>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,0,0,0.2); border: none; color: white; padding: 2px 6px; border-radius: 3px; cursor: pointer;">‚úï</button>
                        </div>
                        <div style="margin: 8px 0; font-size: 11px;">
                            <div>üöå Vehicle Type: ${data.vehicleType}</div>
                            <div>üìä Active Vehicles: ${data.vehicleCount}</div>
                            <div>‚è±Ô∏è Response Time: ${Math.round(data.responseTime)}ms</div>
                        </div>
                    `;

                    // Directions breakdown
                    if (Object.keys(data.directions).length > 0) {
                        html += `<div style="margin: 8px 0;"><strong>Directions:</strong>`;
                        for (const [direction, count] of Object.entries(data.directions)) {
                            html += ` <span style="background: rgba(79,172,254,0.2); padding: 2px 6px; border-radius: 3px; margin: 2px; font-size: 10px;">${direction} (${count})</span>`;
                        }
                        html += `</div>`;
                    }

                    // Sample vehicles
                    if (data.vehicles.length > 0) {
                        html += `
                            <div style="margin: 8px 0;">
                                <strong>Sample Vehicles (showing ${Math.min(data.vehicles.length, 5)}):</strong>
                                <div style="max-height: 120px; overflow-y: auto; margin-top: 4px;">
                        `;

                        data.vehicles.slice(0, 5).forEach(vehicle => {
                            html += `
                                <div style="font-size: 10px; margin: 2px 0; padding: 3px; background: rgba(0,0,0,0.2); border-radius: 2px;">
                                    üöå ${vehicle.id}: (${vehicle.lat.toFixed(4)}, ${vehicle.lng.toFixed(4)})
                                    ${Math.round(vehicle.speed)}mph ${Math.round(vehicle.heading)}¬∞ ${vehicle.direction || ''}
                                </div>
                            `;
                        });

                        html += `</div></div>`;
                    }

                    detailsEl.innerHTML = html;
                } else {
                    detailsEl.innerHTML = `<div class="error">‚ùå Route details failed: ${data.error}</div>`;
                }
            } catch (error) {
                detailsEl.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testBartOverview() {
            const statusEl = document.getElementById('bart-overview-status');
            const resultEl = document.getElementById('bart-overview-result');
            const btnEl = document.getElementById('bart-overview-btn');

            setTestStatus('bart-overview', 'testing');
            btnEl.disabled = true;

            try {
                const response = await fetch('/test/bart-overview');
                const data = await response.json();

                if (response.ok) {
                    setTestStatus('bart-overview', 'success');

                    let html = `
                        <div class="success">‚úÖ BART Lines Overview: Complete</div>
                        <div class="metric">
                            <span class="metric-label">Total Lines:</span>
                            <span class="metric-value">${data.totalLines}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Active Trains:</span>
                            <span class="metric-value">${data.totalTrains}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Response Time:</span>
                            <span class="metric-value">${Math.round(data.responseTime)}ms</span>
                        </div>
                    `;

                    if (data.lines && data.lines.length > 0) {
                        html += `
                            <div class="transport-breakdown">
                                <strong>üöá Active BART Lines:</strong>
                                <div style="margin-left: 10px; font-size: 11px;">
                        `;

                        data.lines.forEach(line => {
                            html += `
                                <div style="margin: 4px 0; padding: 4px; background: rgba(255,255,255,0.05); border-radius: 3px; cursor: pointer;"
                                     onclick="testSpecificBartLine('${line.code}')"
                                     onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                                     onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                    <div style="display: flex; justify-content: space-between;">
                                        <strong>üîó ${line.code}</strong>
                                        <span>${line.trains} trains</span>
                                    </div>
                                    <div style="font-size: 10px; color: #ccc;">
                                        ${line.stations} stations ‚Ä¢ ${line.direction}
                                    </div>
                                </div>
                            `;
                        });

                        html += `
                                </div>
                                <div style="margin-top: 10px; font-size: 11px; color: #888;">
                                    Click any line above for detailed analysis
                                </div>
                            </div>
                        `;
                    }

                    html += `<div style="margin-top: 10px; font-size: 11px; color: #888;">
                        Last updated: ${new Date().toLocaleTimeString()}
                    </div>`;

                    resultEl.innerHTML = html;
                } else {
                    setTestStatus('bart-overview', 'error');
                    resultEl.innerHTML = `
                        <div class="error">‚ùå BART Overview Failed</div>
                        <div class="error">Error: ${data.error}</div>
                        <div class="warning">üí° Check your BART_API_KEY in .env file</div>
                    `;
                }
            } catch (error) {
                setTestStatus('bart-overview', 'error');
                resultEl.innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                    <div class="warning">üí° Check your BART_API_KEY in .env file</div>
                `;
            }

            btnEl.disabled = false;
        }

        function testSpecificBartLine(lineCode) {
            // Set the line code in the input and trigger the detailed analysis
            document.getElementById('bart-line-input').value = lineCode;
            testBartLineDetails();
        }

        async function testBartLineDetails() {
            const statusEl = document.getElementById('bart-line-status');
            const resultEl = document.getElementById('bart-line-result');
            const btnEl = document.getElementById('bart-line-btn');
            const lineInput = document.getElementById('bart-line-input');

            const line = lineInput.value.trim().toUpperCase();
            if (!line) {
                resultEl.innerHTML = `<div class="error">‚ùå Please enter a BART line code</div>`;
                return;
            }

            setTestStatus('bart-line', 'testing');
            btnEl.disabled = true;

            try {
                const response = await fetch(`/test/bart-line-details/${line}`);
                const data = await response.json();

                if (response.ok) {
                    setTestStatus('bart-line', 'success');

                    let html = `
                        <div class="success">‚úÖ BART Line ${data.line}: Analysis Complete</div>
                        <div class="metric">
                            <span class="metric-label">Stations Served:</span>
                            <span class="metric-value">${data.stationCount}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Active Trains:</span>
                            <span class="metric-value">${data.trainCount}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Response Time:</span>
                            <span class="metric-value">${Math.round(data.responseTime)}ms</span>
                        </div>
                    `;

                    // Directions breakdown
                    if (Object.keys(data.directions).length > 0) {
                        html += `
                            <div class="transport-breakdown">
                                <strong>Directions:</strong>
                                <div style="margin-left: 10px; font-size: 11px;">
                        `;
                        for (const [destination, count] of Object.entries(data.directions)) {
                            html += `<div>‚Üí ${destination}: ${count} trains</div>`;
                        }
                        html += `</div></div>`;
                    }

                    // Stations
                    if (data.stations.length > 0) {
                        html += `
                            <div class="transport-breakdown">
                                <strong>Stations (${data.stationCount}):</strong>
                                <div style="max-height: 100px; overflow-y: auto; margin-left: 10px; font-size: 10px;">
                        `;
                        data.stations.forEach((station, i) => {
                            html += `<div>${i + 1}. ${station}</div>`;
                        });
                        html += `</div></div>`;
                    }

                    // Next departures
                    if (data.nextDepartures.length > 0) {
                        html += `
                            <div class="transport-breakdown">
                                <strong>Next Departures:</strong>
                                <div style="max-height: 120px; overflow-y: auto; font-size: 10px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; font-weight: bold; margin-bottom: 5px; padding: 3px; background: rgba(255,255,255,0.1);">
                                        <div>Station</div><div>Destination</div><div>Minutes</div><div>Platform</div>
                                    </div>
                        `;
                        data.nextDepartures.slice(0, 10).forEach(departure => {
                            html += `
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin: 2px 0; padding: 2px; background: rgba(0,0,0,0.1);">
                                    <div>${departure.station.substring(0, 12)}</div>
                                    <div>${departure.destination.substring(0, 12)}</div>
                                    <div>${departure.minutes}</div>
                                    <div>${departure.platform}</div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }

                    html += `<div style="margin-top: 10px; font-size: 11px; color: #888;">
                        Last updated: ${new Date().toLocaleTimeString()}
                    </div>`;

                    resultEl.innerHTML = html;
                } else {
                    setTestStatus('bart-line', 'error');
                    resultEl.innerHTML = `
                        <div class="error">‚ùå BART Line Analysis Failed</div>
                        <div class="error">Error: ${data.error}</div>
                        <div class="warning">üí° Try: ANTC, DALY, DUBL, FRMT, MLBR, RICH, WARM</div>
                    `;
                }
            } catch (error) {
                setTestStatus('bart-line', 'error');
                resultEl.innerHTML = `
                    <div class="error">‚ùå Error: ${error.message}</div>
                    <div class="warning">üí° Check your BART_API_KEY in .env file</div>
                `;
            }

            btnEl.disabled = false;
        }

        async function testServerHealth() {
            const statusEl = document.getElementById('health-status');
            const resultEl = document.getElementById('health-result');
            const btnEl = document.getElementById('health-btn');

            setTestStatus('health', 'testing');
            btnEl.disabled = true;

            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                if (response.ok) {
                    setTestStatus('health', 'success');
                    testResults.health = { status: 'success', data };

                    resultEl.innerHTML = `
                        <div class="success">‚úÖ Server Health: OK</div>
                        <div class="metric">
                            <span class="metric-label">Status:</span>
                            <span class="metric-value">${data.status}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Vehicles:</span>
                            <span class="metric-value">${data.vehicles}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Last Update:</span>
                            <span class="metric-value">${data.lastUpdate ? new Date(data.lastUpdate).toLocaleString() : 'None'}</span>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                setTestStatus('health', 'error');
                testResults.health = { status: 'error', error: error.message };
                resultEl.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }

            btnEl.disabled = false;
            updateSummary();
        }

        // testOtherAPIs function removed - NextMuni integration discontinued
        // BART testing now handled by dedicated BART test cards above

        function testAllAgencies() {
            const agencies = ['SF', 'GG', 'AC', 'RG'];
            testServerHealth();

            agencies.forEach((agency, index) => {
                setTimeout(() => testAgency(agency), (index + 1) * 1000);
            });

            // testOtherAPIs() call removed - NextMuni integration discontinued
            setTimeout(testEnhanced511, 6000);
            setTimeout(testBartOverview, 7000);
        }

        function setTestStatus(testName, status) {
            const statusEl = document.getElementById(`${testName}-status`);
            if (statusEl) {
                statusEl.className = `status-indicator ${status}`;
            }
        }

        function updateSummary() {
            const totalAgencies = Object.keys(testResults).length;
            const successfulAgencies = Object.values(testResults).filter(r => r.status === 'success').length;
            const totalVehicles = Object.values(testResults)
                .filter(r => r.status === 'success' && r.data)
                .reduce((sum, r) => sum + (r.data.vehicleCount || r.data.vehicles || 0), 0);

            document.getElementById('total-agencies').textContent = totalAgencies;
            document.getElementById('total-vehicles').textContent = totalVehicles;
            document.getElementById('success-rate').textContent =
                totalAgencies > 0 ? Math.round((successfulAgencies / totalAgencies) * 100) + '%' : '0%';
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        function clearResults() {
            testResults = {};
            const resultContainers = document.querySelectorAll('.result-container');
            resultContainers.forEach(container => {
                container.innerHTML = '<p>Click to run test...</p>';
            });

            const statusIndicators = document.querySelectorAll('.status-indicator');
            statusIndicators.forEach(indicator => {
                indicator.className = 'status-indicator';
            });

            updateSummary();
        }

        function toggleLiveMode() {
            liveMode = !liveMode;

            if (liveMode) {
                liveInterval = setInterval(testAllAgencies, 30000);
                console.log('Live mode enabled - testing every 30 seconds');
            } else {
                if (liveInterval) {
                    clearInterval(liveInterval);
                    liveInterval = null;
                }
                console.log('Live mode disabled');
            }
        }
        async function testRoutes() {
          const statusEl = document.getElementById('gtfs-status');
          const resultEl = document.getElementById('gtfs-result');
          const btnEl    = document.getElementById('routes-btn');

          setTestStatus('gtfs', 'testing');
          btnEl.disabled = true;

          try {
            const response = await fetch('/api/routes');
            const data     = await response.json();

            if (!response.ok) throw new Error(`Routes API failed: ${response.status}`);

            setTestStatus('gtfs', 'success');
            let html = `
              <div class="success">‚úÖ Routes Data: Loaded Successfully</div>
              <div class="metric">
                <span class="metric-label">Data Source:</span>
                <span class="metric-value">${
                  data.metadata?.type === 'hand-coded-waypoints'
                    ? 'üìù Hand-Coded'
                    : 'üó∫Ô∏è Real GTFS'
                }</span>
              </div>
              <div class="metric">
                <span class="metric-label">Routes Available:</span>
                <span class="metric-value">${Object.keys(data.routes).length}</span>
              </div>
            `;

            if (data.metadata?.last_updated) {
              const lu = new Date(data.metadata.last_updated);
              html += `
                <div class="metric">
                  <span class="metric-label">Last Updated:</span>
                  <span class="metric-value">
                    ${lu.toLocaleDateString()} ${lu.toLocaleTimeString()}
                  </span>
                </div>
              `;
            }

            html += `<div class="transport-breakdown">
              <strong>üìã Available Routes:</strong>
              <div style="margin-left:10px;font-size:11px;">
            `;
            for (const [id, r] of Object.entries(data.routes)) {
              const pts      = (r.shape || []).length;
              const name     = r.name || id;
              const dir      = r.direction ? ` (${r.direction})` : '';
              const shapeId  = r.shape_id ? ` [${r.shape_id}]` : '';
              html += `
                <div style="margin:3px 0;padding:3px;background:rgba(255,255,255,0.05);border-radius:2px;">
                  <div style="display:flex;justify-content:space-between;">
                    <span>üöä <strong>${name}${dir}</strong></span>
                    <span>${pts} points</span>
                  </div>
                  ${shapeId ? `<div style="font-size:10px;color:#888;">${shapeId}</div>` : ''}
                </div>
              `;
            }
            html += `</div></div>
              <div style="margin-top:10px;font-size:11px;color:#888;">
                Test completed: ${new Date().toLocaleTimeString()}
              </div>
            `;
            resultEl.innerHTML = html;
          } catch (err) {
            setTestStatus('gtfs', 'error');
            resultEl.innerHTML = `
              <div class="error">‚ùå Routes Test Failed</div>
              <div class="error">Error: ${err.message}</div>
              <div class="warning">üí° Check server logs for details</div>
            `;
          } finally {
            btnEl.disabled = false;
          }
        }
        async function testGTFSConnectivity() {
          const statusEl = document.getElementById('gtfs-status');
          const resultEl = document.getElementById('gtfs-result');
          const btnEl    = document.getElementById('connectivity-btn');

          setTestStatus('gtfs', 'testing');
          btnEl.disabled = true;

          resultEl.innerHTML = `
            <div style="color:#ff9800;">üîç Testing GTFS connectivity‚Ä¶</div>
            <div style="font-size:11px;margin-top:5px;color:#ccc;">
              Checking multiple GTFS sources and network connectivity‚Ä¶
            </div>
          `;

          try {
            const response = await fetch('/test/gtfs-connectivity');
            const data     = await response.json();
            if (!response.ok) throw new Error(`Connectivity test failed: ${response.status}`);

            const allPassed = Object.values(data.connectivity_tests)
                                    .every(t => t.success);
            setTestStatus('gtfs', allPassed ? 'success' : 'error');

            let html = `
              <div class="${allPassed ? 'success' : 'warning'}">
                ${allPassed ? '‚úÖ' : '‚ö†Ô∏è'} GTFS Connectivity Test: ${
                  allPassed ? 'All Sources Accessible' : 'Issues Detected'
                }
              </div>
            `;
            // ‚Ä¶build out DNS + per‚Äêsource blocks‚Ä¶
            // (see full implementation)
            resultEl.innerHTML = html;
          } catch (err) {
            setTestStatus('gtfs', 'error');
            resultEl.innerHTML = `
              <div class="error">‚ùå Connectivity Test Failed</div>
              <div class="error">Error: ${err.message}</div>
              <div class="warning">üí° Check server connection and try again</div>
            `;
          } finally {
            btnEl.disabled = false;
          }
        }

        async function refreshGTFS() {
          const statusEl = document.getElementById('gtfs-status');
          const resultEl = document.getElementById('gtfs-result');
          const btnEl    = document.getElementById('refresh-btn');

          setTestStatus('gtfs', 'testing');
          btnEl.disabled = true;

          resultEl.innerHTML = `
            <div style="color:#ff9800;">üîÑ Downloading GTFS data from SFMTA‚Ä¶</div>
            <div style="font-size:11px;margin-top:5px;color:#ccc;">
              This may take 10‚Äì30 seconds‚Ä¶
            </div>
          `;

          try {
            const startTime = Date.now();
            const resp      = await fetch('/api/refresh-routes');
            const data      = await resp.json();
            const ms        = Date.now() - startTime;

            if (!resp.ok || data.status !== 'success')
              throw new Error(data.message || `HTTP ${resp.status}`);

            setTestStatus('gtfs', 'success');
            let html = `
              <div class="success">‚úÖ GTFS Refresh: ${data.message}</div>
              <div class="metric">
                <span class="metric-label">Response Time:</span>
                <span class="metric-value">${Math.round(ms)}ms</span>
              </div>
              <div class="metric">
                <span class="metric-label">Routes Updated:</span>
                <span class="metric-value">${(data.routes_updated||[]).length}</span>
              </div>
              <div class="metric">
                <span class="metric-label">Timestamp:</span>
                <span class="metric-value">${new Date(data.timestamp).toLocaleTimeString()}</span>
              </div>
            `;
            // ‚Ä¶show list of updated routes with point counts‚Ä¶
            resultEl.innerHTML = html;
          } catch (err) {
            setTestStatus('gtfs', 'error');
            resultEl.innerHTML = `
              <div class="error">‚ùå GTFS Refresh Failed</div>
              <div class="error">Error: ${err.message}</div>
              <div class="warning">üí° Check server connection and try again</div>
            `;
          } finally {
            btnEl.disabled = false;
          }
        }

        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                testResults: testResults,
                summary: {
                    totalAgencies: Object.keys(testResults).length,
                    successfulAgencies: Object.values(testResults).filter(r => r.status === 'success').length,
                    totalVehicles: Object.values(testResults)
                        .filter(r => r.status === 'success' && r.data)
                        .reduce((sum, r) => sum + (r.data.vehicleCount || r.data.vehicles || 0), 0)
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sf-transit-enhanced-test-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Auto-run server health check on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(testServerHealth, 1000);
        });
    </script>
</body>
</html>