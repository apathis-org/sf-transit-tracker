<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Transit Tracker - Route-Aware</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            overflow: hidden;
        }

        #map { width: 100vw; height: 100vh; }

        .panel {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .status-panel {
            top: 10px;
            left: 10px;
            z-index: 1000;
        }

        .filter-panel {
            top: 10px;
            left: 200px;
            width: 250px;
            max-height: calc(100vh - 20px);
            overflow-y: auto;
            z-index: 1000;
        }

        .info-panel {
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group h4 {
            color: #4facfe;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
        }

        .filter-item input {
            margin-right: 8px;
        }

        .filter-name {
            flex: 1;
        }

        .filter-count {
            background: rgba(255,255,255,0.1);
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 4px;
        }

        .filter-count.active {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .filter-count.inactive {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        /* Vehicle icons */
        .transit-icon {
            border-radius: 50%;
            border: 2px solid white;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            min-height: 20px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        .transit-icon:hover { transform: scale(1.2); }

        .muni-bus { background: #e31837; }
        .bart-train { background: #0099cc; }
        .cable-car { background: #8b4513; }
        .light-rail { background: #ff6600; }
        .ferry { background: #006a4e; }
        .bus { background: #4CAF50; }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .status-indicator {
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .connected { background: #4CAF50; }
        .error { background: #f44336; }
        .connecting { background: #ff9800; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Debug controls */
        .debug-controls {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .debug-button {
            background: rgba(255,165,0,0.3);
            border: 1px solid #ffa500;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            margin: 2px;
        }

        .debug-button:hover {
            background: rgba(255,165,0,0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="panel status-panel">
        <div class="status-indicator" id="status">
            <div class="status-dot connecting"></div>
            Connecting...
        </div>
        <div style="font-size: 10px; margin-top: 4px; opacity: 0.8;" id="update-time">
            Last update: --:--
        </div>
        <div style="font-size: 10px; margin-top: 4px; opacity: 0.8;" id="route-status">
            Routes: Loading...
        </div>
    </div>

    <div class="panel filter-panel">
        <h3 style="color: #4facfe; margin-bottom: 10px;">üéõÔ∏è Filters</h3>

        <div class="filter-group">
            <h4>SFMTA (San Francisco)</h4>
            <div class="filter-item">
                <input type="checkbox" id="filter-muni-bus" checked>
                <span class="filter-name">Muni Buses</span>
                <span class="filter-count" id="count-muni-bus">0</span>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="filter-light-rail" checked>
                <span class="filter-name">Light Rail</span>
                <span class="filter-count" id="count-light-rail">0</span>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="filter-cable-car">
                <span class="filter-name">Cable Cars</span>
                <span class="filter-count" id="count-cable-car">0</span>
            </div>
        </div>

        <div class="filter-group">
            <h4>BART</h4>
            <div class="filter-item">
                <input type="checkbox" id="filter-bart-train">
                <span class="filter-name">BART Trains</span>
                <span class="filter-count" id="count-bart-train">0</span>
            </div>
        </div>

        <div class="filter-group">
            <h4>Golden Gate</h4>
            <div class="filter-item">
                <input type="checkbox" id="filter-gg-bus">
                <span class="filter-name">GG Buses</span>
                <span class="filter-count" id="count-gg-bus">0</span>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="filter-ferry">
                <span class="filter-name">Ferries</span>
                <span class="filter-count" id="count-ferry">0</span>
            </div>
        </div>

        <div class="filter-group">
            <h4>AC Transit</h4>
            <div class="filter-item">
                <input type="checkbox" id="filter-ac-bus">
                <span class="filter-name">AC Buses</span>
                <span class="filter-count" id="count-ac-bus">0</span>
            </div>
        </div>

        <div class="filter-group bay-area-section">
            <div class="bay-area-header" id="bay-area-toggle">
                <h4>Bay Area Regions <span class="collapse-icon">‚ñ∂</span></h4>
            </div>
            <div class="bay-area-content" id="bay-area-content" style="display: none;">
                <div class="filter-item">
                    <input type="checkbox" id="filter-caltrain" checked>
                    <span class="filter-name">Caltrain</span>
                    <span class="filter-count" id="count-caltrain">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-capitol-corridor">
                    <span class="filter-name">Capitol Corridor</span>
                    <span class="filter-count" id="count-capitol-corridor">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-ace-train">
                    <span class="filter-name">ACE Train</span>
                    <span class="filter-count" id="count-ace-train">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-smart-rail">
                    <span class="filter-name">SMART Rail</span>
                    <span class="filter-count" id="count-smart-rail">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-sf-bay-ferry">
                    <span class="filter-name">SF Bay Ferry</span>
                    <span class="filter-count" id="count-sf-bay-ferry">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-vta">
                    <span class="filter-name">VTA</span>
                    <span class="filter-count" id="count-vta">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-samtrans">
                    <span class="filter-name">SamTrans</span>
                    <span class="filter-count" id="count-samtrans">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-tri-delta">
                    <span class="filter-name">Tri Delta Transit</span>
                    <span class="filter-count" id="count-tri-delta">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-county-connection">
                    <span class="filter-name">County Connection</span>
                    <span class="filter-count" id="count-county-connection">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-marin-transit">
                    <span class="filter-name">Marin Transit</span>
                    <span class="filter-count" id="count-marin-transit">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-dumbarton-express">
                    <span class="filter-name">Dumbarton Express</span>
                    <span class="filter-count" id="count-dumbarton-express">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-emery-go-round">
                    <span class="filter-name">Emery Go-Round</span>
                    <span class="filter-count" id="count-emery-go-round">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-fs-transit">
                    <span class="filter-name">FS Transit</span>
                    <span class="filter-count" id="count-fs-transit">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-mv-transportation">
                    <span class="filter-name">MV Transportation</span>
                    <span class="filter-count" id="count-mv-transportation">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-presidio-go">
                    <span class="filter-name">Presidio Go</span>
                    <span class="filter-count" id="count-presidio-go">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-sonoma-county">
                    <span class="filter-name">Sonoma County Transit</span>
                    <span class="filter-count" id="count-sonoma-county">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-sonoma-county-sr">
                    <span class="filter-name">Sonoma County Transit (SR)</span>
                    <span class="filter-count" id="count-sonoma-county-sr">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-soltrans">
                    <span class="filter-name">SolTrans</span>
                    <span class="filter-count" id="count-soltrans">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-union-city">
                    <span class="filter-name">Union City Transit</span>
                    <span class="filter-count" id="count-union-city">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-vacaville">
                    <span class="filter-name">Vacaville City Coach</span>
                    <span class="filter-count" id="count-vacaville">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-vine-transit">
                    <span class="filter-name">Vine Transit</span>
                    <span class="filter-count" id="count-vine-transit">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-westcat">
                    <span class="filter-name">WestCAT</span>
                    <span class="filter-count" id="count-westcat">0</span>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-wheels">
                    <span class="filter-name">Wheels</span>
                    <span class="filter-count" id="count-wheels">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="panel info-panel">
        <h3>üöå Transit Tracker</h3>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-vehicles">0</div>
                <div class="stat-label">Vehicles</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-agencies">0</div>
                <div class="stat-label">Agencies</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="route-aware-count">0</div>
                <div class="stat-label">Route-Aware</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="routes-loaded">0</div>
                <div class="stat-label">Routes Loaded</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="/static/routeManager.js"></script>
    <script>
        class SimpleTransitTracker {
            constructor() {
                this.map = null;
                this.vehicles = new Map();
                this.markers = new Map();
                this.socket = null;
                this.vehicleCounts = {};
                this.routeManager = null;

                // Animation system
                this.vehicleStates = new Map(); // Store animation state for each vehicle
                this.animationFrame = null;
                this.lastUpdateTime = Date.now();

                // Location configuration
                this.locationConfig = {
                    defaultCenter: [37.7749, -122.4194], // SF coordinates
                    defaultZoom: 12,                     // City-wide view
                    userLocationZoom: 14,                // Neighborhood view
                    geolocationTimeout: 10000,           // 10 seconds
                    geolocationMaxAge: 300000            // 5 minutes
                };

                // Expanded filter mapping including all Bay Area Regional agencies
                this.filters = {
                    // Existing filters (keep unchanged)
                    'muni-bus': { agency: 'SFMTA', type: 'muni-bus' },
                    'light-rail': { agency: 'SFMTA', type: 'light-rail' },
                    'cable-car': { agency: 'SFMTA', type: 'cable-car' },
                    'bart-train': { agency: 'BART', type: 'bart-train' },
                    'gg-bus': { agency: 'Golden Gate', type: 'bus' },
                    'ferry': { agency: 'Golden Gate', type: 'ferry' },
                    'ac-bus': { agency: 'AC Transit', type: 'bus' },
                    
                    // New Bay Area Regional filters
                    'caltrain': { agency: 'Caltrain', type: 'train' },
                    'capitol-corridor': { agency: 'Capitol Corridor', type: 'train' },
                    'ace-train': { agency: 'Altamont Corridor Express', type: 'train' },
                    'smart-rail': { agency: 'SMART', type: 'train' },
                    'sf-bay-ferry': { agency: 'SF Bay Ferry', type: 'ferry' },
                    'vta': { agency: 'VTA', type: 'bus' },
                    'samtrans': { agency: 'SamTrans', type: 'bus' },
                    'tri-delta': { agency: 'Tri Delta Transit', type: 'bus' },
                    'county-connection': { agency: 'County Connection', type: 'bus' },
                    'marin-transit': { agency: 'Marin Transit', type: 'bus' },
                    'dumbarton-express': { agency: 'Dumbarton Express', type: 'bus' },
                    'emery-go-round': { agency: 'Emery Go-Round', type: 'bus' },
                    'fs-transit': { agency: 'FS Transit', type: 'bus' },
                    'mv-transportation': { agency: 'MV Transportation', type: 'bus' },
                    'presidio-go': { agency: 'Presidio Go', type: 'bus' },
                    'sonoma-county': { agency: 'Sonoma County Transit', type: 'bus' },
                    'sonoma-county-sr': { agency: 'Sonoma County Transit (SR)', type: 'bus' },
                    'soltrans': { agency: 'SolTrans', type: 'bus' },
                    'union-city': { agency: 'Union City Transit', type: 'bus' },
                    'vacaville': { agency: 'Vacaville City Coach', type: 'bus' },
                    'vine-transit': { agency: 'Vine Transit', type: 'bus' },
                    'westcat': { agency: 'WestCAT', type: 'bus' },
                    'wheels': { agency: 'Wheels', type: 'bus' }
                };

                this.init();
                this.initializeRouteManager();
                this.setupFilters();
                this.setupBayAreaToggle();
                this.connectSocket();
                this.startAnimationLoop();
            }

            async init() {
                // Initialize map with default view
                this.map = L.map('map').setView(this.locationConfig.defaultCenter, this.locationConfig.defaultZoom);
                
                // Load dark mode map tiles with visible street names and grid
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(this.map);
                
                // Add bright labels overlay for readable street names
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                    subdomains: 'abcd',
                    maxZoom: 20,
                    pane: 'overlayPane'
                }).addTo(this.map);

                // Try to center map on user's location
                this.requestUserLocation();
            }

            requestUserLocation() {
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    console.log('Geolocation not supported, using default location');
                    return;
                }

                // Request user's current location with configured options
                navigator.geolocation.getCurrentPosition(
                    (position) => this.handleLocationSuccess(position),
                    (error) => this.handleLocationError(error),
                    this.getGeolocationOptions()
                );
            }

            handleLocationSuccess(position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                console.log(`Centering map on user location: ${userLat}, ${userLng}`);
                
                // Center map on user location with configured zoom
                this.map.setView([userLat, userLng], this.locationConfig.userLocationZoom);
                
                // Add user location marker
                this.addUserLocationMarker(userLat, userLng);
            }

            handleLocationError(error) {
                const errorMessages = {
                    [error.PERMISSION_DENIED]: 'Location access denied by user',
                    [error.POSITION_UNAVAILABLE]: 'Location information unavailable',
                    [error.TIMEOUT]: 'Location request timed out'
                };
                
                const message = errorMessages[error.code] || 'Location access denied';
                console.log(`${message}, using default location`);
                // Map stays at default location
            }

            getGeolocationOptions() {
                return {
                    enableHighAccuracy: false,                    // Faster response, less battery
                    timeout: this.locationConfig.geolocationTimeout,
                    maximumAge: this.locationConfig.geolocationMaxAge
                };
            }

            addUserLocationMarker(lat, lng) {
                const userIcon = this.createUserLocationIcon();
                
                L.marker([lat, lng], { icon: userIcon })
                    .addTo(this.map)
                    .bindPopup("üìç You are here");
            }

            createUserLocationIcon() {
                return L.divIcon({
                    className: 'user-location-icon',
                    html: '<div class="user-location-dot"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
            }
            async initializeRouteManager() {
                // Initialize route-aware animation
                this.routeManager = new RouteManager();
                const success = await this.routeManager.initialize();
                document.getElementById('route-status').textContent =
                    success ? `Routes: ${this.routeManager.routes.size} loaded ‚ú®` : 'Routes: Failed to load';

                document.getElementById('routes-loaded').textContent = this.routeManager.routes.size;
            }

            setupFilters() {
                Object.keys(this.filters).forEach(filterId => {
                    const checkbox = document.getElementById(`filter-${filterId}`);
                    if (checkbox) {
                        checkbox.addEventListener('change', () => {
                            this.updateVisibleVehicles();
                        });
                    }
                });
            }

            setupBayAreaToggle() {
                const bayAreaToggle = document.getElementById('bay-area-toggle');
                const bayAreaContent = document.getElementById('bay-area-content');
                const bayAreaSection = document.querySelector('.bay-area-section');

                if (bayAreaToggle && bayAreaContent && bayAreaSection) {
                    bayAreaToggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const isCurrentlyExpanded = bayAreaSection.classList.contains('expanded');
                        
                        if (isCurrentlyExpanded) {
                            // Collapse
                            bayAreaSection.classList.remove('expanded');
                            bayAreaContent.style.display = 'none';
                        } else {
                            // Expand
                            bayAreaSection.classList.add('expanded');
                            bayAreaContent.style.display = 'block';
                        }
                    });
                } else {
                    console.error('Bay Area toggle elements not found!');
                }
            }

            connectSocket() {
                this.updateStatus('connecting');

                this.socket = io();

                this.socket.on('connect', () => {
                    this.updateStatus('connected');
                });

                this.socket.on('bulk_update', (data) => {
                    this.handleVehicleUpdate(data);
                });

                this.socket.on('disconnect', () => {
                    this.updateStatus('error');
                });

                // Fallback to HTTP if socket fails
                setTimeout(() => {
                    if (!this.socket || !this.socket.connected) {
                        this.fallbackToHTTP();
                    }
                }, 5000);
            }

            async fallbackToHTTP() {
                this.updateStatus('connected');
                setInterval(async () => {
                    try {
                        const response = await fetch('/api/vehicles');
                        const data = await response.json();
                        this.handleVehicleUpdate({ vehicles: data.vehicles });
                    } catch (error) {
                        console.error('HTTP fetch failed:', error);
                    }
                }, 30000);
            }

            handleVehicleUpdate(data) {
                if (!data.vehicles || !Array.isArray(data.vehicles)) {
                    console.log('No vehicle data received, keeping existing vehicles');
                    return;
                }

                // Only proceed if we have actual vehicle data
                if (data.vehicles.length === 0) {
                    console.log('Empty vehicle array received, keeping existing vehicles');
                    return;
                }

                console.log(`Received ${data.vehicles.length} vehicles`);

                // Store current time for animation calculations
                const updateTime = Date.now();

                // Process new vehicle data
                const newVehicles = new Map();
                const newVehicleCounts = {};

                data.vehicles.forEach(vehicle => {
                    newVehicles.set(vehicle.id, vehicle);

                    // DEBUG: Log fast vehicles when new data arrives
                    if (vehicle.speed && vehicle.speed > 40) {
                        console.log(`‚ö° FAST Vehicle ${vehicle.id}: ${vehicle.speed.toFixed(1)}mph, type: ${vehicle.type}, agency: ${vehicle.agency}`);
                    }

                    // Update animation state for each vehicle
                    this.updateVehicleAnimationState(vehicle, updateTime);

                    // Count by filter categories
                    const filterKey = this.getFilterKey(vehicle);
                    if (filterKey) {
                        newVehicleCounts[filterKey] = (newVehicleCounts[filterKey] || 0) + 1;
                    }
                });

                // Update vehicles and counts
                this.vehicles = newVehicles;
                this.vehicleCounts = newVehicleCounts;
                this.lastUpdateTime = updateTime;

                this.updateCounts();
                this.updateVisibleVehicles();
                this.updateStats();

                // Update last update time
                document.getElementById('update-time').textContent =
                    `Last update: ${new Date().toLocaleTimeString()}`;
            }

            updateVehicleAnimationState(vehicle, updateTime) {
                const vehicleId = vehicle.id;
                const existingState = this.vehicleStates.get(vehicleId);

                if (!existingState) {
                    // New vehicle - create initial state
                    this.vehicleStates.set(vehicleId, {
                        id: vehicleId,
                        startPos: { lat: vehicle.lat, lng: vehicle.lng },
                        targetPos: { lat: vehicle.lat, lng: vehicle.lng },
                        currentPos: { lat: vehicle.lat, lng: vehicle.lng },
                        startSpeed: vehicle.speed || 0,
                        targetSpeed: vehicle.speed || 0,
                        currentSpeed: vehicle.speed || 0,
                        startHeading: vehicle.heading || 0,
                        targetHeading: vehicle.heading || 0,
                        currentHeading: vehicle.heading || 0,
                        animationStartTime: updateTime,
                        isNew: true,
                        lastIdleTime: updateTime
                    });
                } else {
                    // Existing vehicle - update animation target
                    const timeSinceLastUpdate = (updateTime - this.lastUpdateTime) / 1000; // seconds

                    // Calculate projected position based on current speed and heading
                    const projectedPos = this.calculateProjectedPosition(
                        { lat: vehicle.lat, lng: vehicle.lng },
                        vehicle.speed || 0,
                        vehicle.heading || 0,
                        30 // 30 seconds until next update
                    );

                    // Update state for smooth transition
                    existingState.startPos = { ...existingState.currentPos };
                    existingState.targetPos = projectedPos;
                    existingState.startSpeed = existingState.currentSpeed;
                    existingState.targetSpeed = vehicle.speed || 0;
                    existingState.startHeading = existingState.currentHeading;
                    existingState.targetHeading = vehicle.heading || 0;
                    existingState.animationStartTime = updateTime;
                    existingState.isNew = false;
                }
            }

            calculateProjectedPosition(currentPos, speed, heading, timeSeconds) {
                if (!speed || speed < 1) {
                    return currentPos; // Stationary vehicle
                }

                // Convert speed from mph to meters per second
                const metersPerSecond = speed * 0.44704;
                const distanceMeters = metersPerSecond * timeSeconds;

                // Convert heading to radians (heading is in degrees, 0 = North)
                const headingRadians = (heading - 90) * (Math.PI / 180);

                // Calculate position change in meters
                const deltaLat = (distanceMeters * Math.sin(headingRadians)) / 111320; // meters to degrees lat
                const deltaLng = (distanceMeters * Math.cos(headingRadians)) / (111320 * Math.cos(currentPos.lat * Math.PI / 180)); // meters to degrees lng

                return {
                    lat: currentPos.lat + deltaLat,
                    lng: currentPos.lng + deltaLng
                };
            }

            getFilterKey(vehicle) {
                // Map vehicle to filter category
                for (const [key, filter] of Object.entries(this.filters)) {
                    if (vehicle.agency === filter.agency && vehicle.type === filter.type) {
                        return key;
                    }
                }
                return null;
            }

            updateCounts() {
                Object.keys(this.filters).forEach(filterId => {
                    const countEl = document.getElementById(`count-${filterId}`);
                    if (countEl) {
                        const count = this.vehicleCounts[filterId] || 0;
                        countEl.textContent = count;
                        countEl.className = `filter-count ${count > 0 ? 'active' : 'inactive'}`;
                    }
                });
            }

            createMarker(vehicle) {
                const state = this.vehicleStates.get(vehicle.id);
                const position = state ? [state.currentPos.lat, state.currentPos.lng] : [vehicle.lat, vehicle.lng];

                const icon = L.divIcon({
                    className: 'transit-icon',
                    html: `<div class="transit-icon ${vehicle.type}">${vehicle.route || '‚Ä¢'}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker(position, { icon })
                    .bindPopup(this.createPopup(vehicle))
                    .addTo(this.map);

                // Set initial opacity for new vehicles (will fade in)
                if (state && state.isNew) {
                    marker.getElement().style.opacity = 0;
                }

                this.markers.set(vehicle.id, marker);
            }

            updateVisibleVehicles() {
                // Remove markers for vehicles that are no longer in our data
                this.markers.forEach((marker, vehicleId) => {
                    if (!this.vehicles.has(vehicleId)) {
                        this.map.removeLayer(marker);
                        this.markers.delete(vehicleId);
                        this.vehicleStates.delete(vehicleId);
                    }
                });

                // Get selected filters
                const selectedFilters = Object.keys(this.filters).filter(filterId => {
                    const checkbox = document.getElementById(`filter-${filterId}`);
                    return checkbox && checkbox.checked;
                });

                // Add/update markers for filtered vehicles
                this.vehicles.forEach(vehicle => {
                    const filterKey = this.getFilterKey(vehicle);
                    if (filterKey && selectedFilters.includes(filterKey)) {
                        if (!this.markers.has(vehicle.id)) {
                            this.createMarker(vehicle);
                        }
                        // Note: Position updates happen in animation loop
                    } else {
                        // Remove marker if filter is unchecked
                        const marker = this.markers.get(vehicle.id);
                        if (marker) {
                            this.map.removeLayer(marker);
                            this.markers.delete(vehicle.id);
                        }
                    }
                });
            }

            startAnimationLoop() {
                const animate = () => {
                    this.updateVehicleAnimations();
                    this.animationFrame = requestAnimationFrame(animate);
                };
                animate();
            }

            updateVehicleAnimations() {
                const currentTime = Date.now();
                const mapBounds = this.map.getBounds();

                this.vehicleStates.forEach((state, vehicleId) => {
                    const marker = this.markers.get(vehicleId);
                    if (!marker) return;

                    // Check if vehicle is in viewport (optimization)
                    if (!mapBounds.contains([state.currentPos.lat, state.currentPos.lng])) {
                        return; // Skip animation for off-screen vehicles
                    }

                    const timeSinceStart = (currentTime - state.animationStartTime) / 1000; // seconds
                    const animationDuration = 35; // Extended to 35 seconds
                    const progress = Math.min(timeSinceStart / animationDuration, 1);

                    let newPos;

                    // Use traditional straight-line animation for all vehicles
                    newPos = this.calculateTraditionalPosition(state, timeSinceStart, animationDuration, progress);

                    // Interpolate speed for smooth transitions (over 3 seconds)
                    const speedTransitionDuration = 3;
                    const speedProgress = Math.min(timeSinceStart / speedTransitionDuration, 1);
                    const speedEaseProgress = 1 - Math.pow(1 - speedProgress, 2);
                    state.currentSpeed = state.startSpeed + (state.targetSpeed - state.startSpeed) * speedEaseProgress;

                    // Handle idle movement for stationary vehicles
                    if (state.currentSpeed < 2) {
                        const timeSinceIdle = (currentTime - state.lastIdleTime) / 1000;
                        if (timeSinceIdle > 8) { // Idle movement every 8 seconds
                            const idleRadius = 0.00002; // ~2 meters
                            const randomAngle = Math.random() * 2 * Math.PI;
                            newPos.lat += Math.sin(randomAngle) * idleRadius;
                            newPos.lng += Math.cos(randomAngle) * idleRadius;
                            state.lastIdleTime = currentTime;
                        }
                    }

                    // Update current position and heading
                    state.currentPos = newPos;

                    // Update marker position
                    marker.setLatLng([newPos.lat, newPos.lng]);

                    // Handle new vehicle fade-in
                    if (state.isNew && timeSinceStart < 1) {
                        const opacity = timeSinceStart; // Fade in over 1 second
                        marker.getElement().style.opacity = opacity;
                    } else if (state.isNew) {
                        marker.getElement().style.opacity = 1;
                        state.isNew = false;
                    }
                });
            }

            calculateTraditionalPosition(state, timeSinceStart, animationDuration, progress) {
                if (progress < 1) {
                    // Normal interpolation phase (0-35 seconds)
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    return {
                        lat: state.startPos.lat + (state.targetPos.lat - state.startPos.lat) * easeProgress,
                        lng: state.startPos.lng + (state.targetPos.lng - state.startPos.lng) * easeProgress
                    };
                } else {
                    // Extended animation phase (35+ seconds) - Continue moving predictively
                    const extraTime = timeSinceStart - animationDuration;
                    const basePos = state.targetPos; // Start from target position

                    // Calculate movement based on current speed and heading
                    const speedMph = state.currentSpeed || 15; // Use current speed or default
                    const heading = state.currentHeading || 0; // Use current heading

                    // Convert speed to movement per second
                    const metersPerSecond = speedMph * 0.44704; // mph to m/s
                    const distanceMeters = metersPerSecond * extraTime;

                    // Convert heading to radians (0¬∞ = North)
                    const headingRadians = (heading - 90) * (Math.PI / 180);

                    // Calculate position offset
                    const deltaLat = (distanceMeters * Math.sin(headingRadians)) / 111320; // meters to degrees
                    const deltaLng = (distanceMeters * Math.cos(headingRadians)) / (111320 * Math.cos(basePos.lat * Math.PI / 180));

                    const newPos = {
                        lat: basePos.lat + deltaLat,
                        lng: basePos.lng + deltaLng
                    };

                    // Add slight randomization to prevent vehicles from moving in perfect straight lines
                    const randomFactor = 0.00001 * Math.sin(extraTime * 0.5); // Small oscillation
                    newPos.lat += randomFactor;
                    newPos.lng += randomFactor * 0.5;

                    return newPos;
                }
            }

            createPopup(vehicle) {
                return `
                    <div style="font-size: 12px;">
                        <strong>${vehicle.agency} ${vehicle.route || 'Vehicle'}</strong><br>
                        Type: ${vehicle.type}<br>
                        Speed: ${Math.round(vehicle.speed || 0)} mph<br>
                        Updated: ${new Date(vehicle.last_update || Date.now()).toLocaleTimeString()}
                    </div>
                `;
            }

            updateStats() {
                const totalVehicles = Array.from(this.vehicles.values()).length;
                const agencies = new Set();

                this.vehicles.forEach(v => {
                    agencies.add(v.agency);
                });

                document.getElementById('total-vehicles').textContent = totalVehicles;
                document.getElementById('total-agencies').textContent = agencies.size;
                document.getElementById('route-aware-count').textContent = '0';
            }

            updateStatus(status) {
                const statusEl = document.getElementById('status');
                const dot = statusEl.querySelector('.status-dot');

                switch(status) {
                    case 'connected':
                        dot.className = 'status-dot connected';
                        statusEl.innerHTML = '<div class="status-dot connected"></div>Connected';
                        break;
                    case 'connecting':
                        dot.className = 'status-dot connecting';
                        statusEl.innerHTML = '<div class="status-dot connecting"></div>Connecting...';
                        break;
                    case 'error':
                        dot.className = 'status-dot error';
                        statusEl.innerHTML = '<div class="status-dot error"></div>Disconnected';
                        break;
                }
            }

            // Debug functions - removed for now
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.tracker = new SimpleTransitTracker();
        });
    </script>
</body>
</html>